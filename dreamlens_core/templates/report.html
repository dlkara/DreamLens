<!DOCTYPE html>
{% load static %}
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>꿈 리포트</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/report.css' %}"/>
</head>
<body>
{% include 'header.html' %}

<h2>내 일기장 분석 리포트</h2>

<div class="report-container">
    <!-- 월 네비게이션 -->
    <div class="month-nav">
        <a href="{% url 'report' prev_yyyymm %}" class="{% if prev_yyyymm < 202301 %}disabled{% endif %}">◀</a>
        <span id="monthText" class="clickable">{{ year }}년 {{ month }}월</span>
        <a href="{% if next_yyyymm <= today_yyyymm %}{% url 'report' next_yyyymm %}{% endif %}"
           class="{% if next_yyyymm > today_yyyymm %}disabled{% endif %}">▶</a>
    </div>

    <!-- 드롭다운 선택기 -->
    <div class="selector hidden" id="selectorBox">
        <select id="yearSelect">
            {% for y in year_list %}
                <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}년</option>
            {% endfor %}
        </select>
        <select id="monthSelect">
            {% for m in month_list %}
                <option value="{{ m }}" {% if m == month %}selected{% endif %}>{{ m }}월</option>
            {% endfor %}
        </select>
        <button id="moveBtn">이동</button>
    </div>

    <!-- 탭 -->
    <div class="tabs">
        <div class="tab active" data-target="dream">꿈 종류 분석</div>
        <div class="tab" data-target="emotion">감정 분석</div>
    </div>

    <!-- 차트 -->
    <div class="chart-wrapper">
        <div id="dreamChartBox" class="chart-box">
            <canvas id="dreamChart"></canvas>
        </div>
        <div id="emotionChartBox" class="chart-box hidden">
            <canvas id="emotionChart"></canvas>
        </div>

        <!-- 차트 문구 -->
        <div class="result-text" id="chartDesc">
            {% if not has_data %}
                {{ year }}년 {{ month }}월에는 꿈 일기가 없습니다.
            {% endif %}
        </div>
    </div>

    <!-- 워드 클라우드 -->
    <div class="wordcloud-section">
        <h3>꿈 키워드 클라우드</h3>
        <div id="wordCloudArea"></div>
    </div>

    <!-- 감정 & 키워드 분석 -->
    <div class="analysis-section">
        <div class="card-header">
        <!-- 분석 기간을 표시해줍니다. -->
        {{ analysis_year }}년 {{ analysis_month }}월의 감정 & 상징 연계 분석
    </div>
    <div class="card-body p-0"> {# 테이블과 카드 경계가 자연스럽도록 패딩 제거 #}
        {% if emotion_keyword_analysis %}
            <table class="table table-hover mb-0"> {# 카드 내부에 꽉 차도록 mb-0 추가 #}
                <thead class="table-light">
                    <tr>
                        <th scope="col" class="ps-4" style="width: 40%;">감정</th>
                        <th scope="col">연관 키워드 Top 3</th>
                    </tr>
                </thead>
                <tbody>
                    {% for emotion, keywords in emotion_keyword_analysis.items %}
                        <tr>
                            <td class="ps-4 fw-bold">{{ emotion }}</td>
                            <td>
                                {% for keyword in keywords %}
                                    <span class="badge bg-secondary me-1">{{ keyword }}</span>
                                {% empty %}
                                    <span class="text-muted small">연관 키워드 없음</span>
                                {% endfor %}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p class="text-center text-muted py-5">해당 기간에 분석할 데이터가 충분하지 않아요. 꿈 일기를 더 작성해보세요!</p>
        {% endif %}
    </div>
    </div>
</div>

{% include 'footer.html' %}

<script>
    const dreamLabels = {{ dream_labels|safe }};
    const dreamData = {{ dream_data|safe }};
    const emotionLabels = {{ emotion_labels|safe }};
    const emotionIcons = {{ emotion_icons|safe }};
    const emotionData = {{ emotion_data|safe }};
    const keywords = {{ keywords|safe }};
    const currentYear = {{ year }};
    const currentMonth = {{ month }};
    const todayYyyymm = {{ today_yyyymm }};
    const hasData = {{ has_data|yesno:"true,false" }};
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/wordcloud@1.1.2/src/wordcloud2.min.js"></script>
<script defer src="{% static 'js/report.js' %}"></script>
</body>
</html>
