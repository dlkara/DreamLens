{% load static %}

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ê¿ˆ í•´ëª½ - DreamLens</title>
    <link rel="stylesheet" href="{% static 'css/common.css' %}">
</head>
<body>
    {% include 'header.html' %}

    <!-- ë¡œë”© ìŠ¤í”¼ë„ˆ -->
    <div class="loading-overlay" id="loadingSpinner">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p class="loading-text">AIê°€ ê¿ˆì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
        </div>
    </div>

    <main class="main-container interpret-page">
        <div class="container">
            <!-- í˜ì´ì§€ í—¤ë” -->
            <div class="page-header">
                <h1 class="page-title">ğŸ”® DreamLens</h1>
                <p class="page-subtitle">ë‹¹ì‹ ì˜ ë¬´ì˜ì‹ì´ ë³´ë‚¸ í¸ì§€ë¥¼ í•¨ê»˜ ì—´ì–´ë³¼ê¹Œìš”?</p>
            </div>

            <!-- ê¿ˆ ì…ë ¥ í¼ -->
            <div class="dream-input-section">
                <div class="card">
                    <form id="dreamForm" method="POST" action="{% url 'dream_interpreter' %}" class="dream-form">
                        {% csrf_token %}
                        <div class="form-group">
                            <label for="dream_content" class="form-label dream-label">ì–´ë–¤ ê¿ˆì„ ê¾¸ì…¨ë‚˜ìš”?</label>
                            <textarea
                                class="form-input dream-textarea"
                                id="dream_content"
                                name="input_text"
                                rows="6"
                                placeholder="ëŒì•„ê°€ì‹  í• ë¨¸ë‹ˆê°€ í™˜í•˜ê²Œ ì›ƒìœ¼ë©° ëˆì„ ì£¼ì…¨ì–´ìš”."
                                required
                            >{{ original_dream }}</textarea>
                        </div>
                        <button type="submit" class="btn btn-primary btn-large btn-full">
                            <span class="btn-icon">ğŸ”®</span>
                            í•´ëª½í•˜ê¸°
                        </button>
                    </form>
                </div>
            </div>

            <!-- í•´ëª½ ê²°ê³¼ í‘œì‹œ ì˜ì—­ -->
            {% if interpretation_result %}
            <div class="results-section">
                <!-- 1. ê¿ˆ ì¢…ë¥˜ ë¶„ì„ -->
                {% if classification_result %}
                <div class="result-card">
                    <div class="result-header">
                        <span class="result-icon">ğŸ“Š</span>
                        <h3 class="result-title">AIê°€ ë¶„ì„í•œ ë‚˜ì˜ ê¿ˆ ì¢…ë¥˜</h3>
                    </div>
                    <div class="result-content classification-result">
                        <p>{{ classification_result }}</p>
                    </div>
                </div>
                {% endif %}

                <!-- 2. ìƒì„¸ í•´ëª½ -->
                <div class="result-card main-result">
                    <div class="result-header">
                        <span class="result-icon">ğŸŒ™</span>
                        <h3 class="result-title">AIê°€ ë“¤ë ¤ì£¼ëŠ” ë‚˜ì˜ ê¿ˆ ì´ì•¼ê¸°</h3>
                    </div>
                    <div class="result-content">
                        <p>{{ interpretation_result }}</p>
                    </div>
                </div>

                <!-- 3. í•µì‹¬ í‚¤ì›Œë“œ -->
                {% if keywords_result %}
                <div class="result-card">
                    <div class="result-header">
                        <span class="result-icon">ğŸ”‘</span>
                        <h3 class="result-title">ê¿ˆì˜ í•µì‹¬ í‚¤ì›Œë“œ</h3>
                    </div>
                    <div class="result-content keywords-result">
                        <p>{{ keywords_result }}</p>
                    </div>
                </div>
                {% endif %}

                <!-- 4. ì„¸ ì¤„ ìš”ì•½ -->
                {% if summary_result %}
                <div class="result-card">
                    <div class="result-header">
                        <span class="result-icon">âœ¨</span>
                        <h3 class="result-title">ì„¸ ì¤„ ìš”ì•½</h3>
                    </div>
                    <div class="result-content">
                        <p>{{ summary_result }}</p>
                    </div>
                </div>
                {% endif %}

                <!-- ì•¡ì…˜ ë²„íŠ¼ë“¤ -->
                <div class="action-buttons">
                    {% if user.is_authenticated %}
                    <form action="{% url 'diary_write' %}" method="POST" class="action-form">
                        {% csrf_token %}
                        <input type="hidden" name="dream_content" value="{{ original_dream }}">
                        <input type="hidden" name="interpretation_result" value="{{ interpretation_result }}">
                        <button type="submit" class="btn btn-primary btn-large">
                            <span class="btn-icon">ğŸ“–</span>
                            ë‚´ ì¼ê¸°ì¥ì— ì¶”ê°€
                        </button>
                    </form>
                    {% else %}
                    <button class="btn btn-primary btn-large" onclick="redirectToLogin()">
                        <span class="btn-icon">ğŸ“–</span>
                        ë‚´ ì¼ê¸°ì¥ì— ì¶”ê°€
                    </button>
                    {% endif %}

                    <button onclick="openShareModal()" class="btn btn-secondary btn-large">
                        <span class="btn-icon">ğŸ“¤</span>
                        ê³µìœ í•˜ê¸°
                    </button>
                </div>
            </div>
            {% endif %}

            <!-- ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ ì˜ì—­ -->
            {% if error %}
            <div class="error-message">
                <span class="error-icon">âŒ</span>
                <span class="error-text">{{ error }}</span>
            </div>
            {% endif %}
        </div>
    </main>

    <!-- ê³µìœ  ëª¨ë‹¬ -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">í•´ëª½ ê²°ê³¼ ê³µìœ í•˜ê¸°</h2>
                <button type="button" class="modal-close" onclick="closeShareModal()">âœ•</button>
            </div>
            <div class="modal-body">
                <p class="modal-description">ì•„ë˜ í…ìŠ¤íŠ¸ë¥¼ ë³µì‚¬í•˜ì—¬ ì¹œêµ¬ë‚˜ SNSì— ê³µìœ í•´ë³´ì„¸ìš”.</p>
                <textarea id="modalTextToCopy" class="modal-textarea" rows="8" readonly></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary btn-large" onclick="copyModalText()">
                    <span class="btn-icon">ğŸ“‹</span>
                    í´ë¦½ë³´ë“œì— ë³µì‚¬
                </button>
            </div>
        </div>
    </div>

    <!-- ë³µì‚¬ ì™„ë£Œ ì•Œë¦¼ -->
    <div class="toast-notification" id="copyToast">
        <span class="toast-icon">âœ…</span>
        <span class="toast-text">í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!</span>
    </div>

    {% include 'footer.html' %}

    <script src="{% static 'js/header.js' %}"></script>
    <script>
        // í¼ ì œì¶œ ì‹œ ë¡œë”© ìŠ¤í”¼ë„ˆ í‘œì‹œ
        document.getElementById('dreamForm').addEventListener('submit', function () {
            document.getElementById('loadingSpinner').style.display = 'flex';
        });

        function openShareModal() {
            const interpretation = '{{ interpretation_result }}';
            const keywords = '{{ keywords_result }}';

            const fullText = `ğŸ”® DreamLens AI ê¿ˆ í•´ëª½ ê²°ê³¼ ğŸ”®\n\nğŸŒ™ ìƒì„¸ í•´ëª½\n${interpretation}\n\nğŸ”‘ ê¿ˆì˜ í•µì‹¬ í‚¤ì›Œë“œ\n${keywords}\n\nì–´ì ¯ë°¤ ê¾¼ ê·¸ ê¿ˆ, DreamLensì—ì„œ ì§„ì§œ ì˜ë¯¸ë¥¼ ì°¾ì•„ë³´ì„¸ìš”!\nhttps://www.dreamlens.com`;

            document.getElementById('modalTextToCopy').value = fullText;
            document.getElementById('modalOverlay').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeShareModal() {
            document.getElementById('modalOverlay').classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        function copyModalText() {
            const textElement = document.getElementById('modalTextToCopy');
            textElement.select();
            textElement.setSelectionRange(0, 99999);

            try {
                document.execCommand('copy');
                showToast();
                setTimeout(() => {
                    closeShareModal();
                }, 500);
            } catch (err) {
                alert('í´ë¦½ë³´ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        function showToast() {
            const toast = document.getElementById('copyToast');
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function redirectToLogin() {
            alert("ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.");
            window.location.href = "{% url 'login' %}?next={{ request.path }}";
        }

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        document.getElementById('modalOverlay').addEventListener('click', function(e) {
            if (e.target === this) {
                closeShareModal();
            }
        });

        // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeShareModal();
            }
        });
    </script>
</body>
</html>