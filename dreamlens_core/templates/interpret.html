{% load static %}

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 꿈 해몽 - DreamLens</title>
    <link rel="stylesheet" href="{% static 'css/common.css' %}">
</head>
<body>
    {% include 'header.html' %}

    <!-- 로딩 스피너 -->
    <div class="loading-overlay" id="loadingSpinner">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p class="loading-text">AI가 꿈을 분석하고 있습니다...</p>
        </div>
    </div>

    <main class="main-container interpret-page">
        <div class="container">
            <!-- 페이지 헤더 -->
            <div class="page-header">
                <h1 class="page-title">🔮 DreamLens</h1>
                <p class="page-subtitle">당신의 무의식이 보낸 편지를 함께 열어볼까요?</p>
            </div>

            <!-- 꿈 입력 폼 -->
            <div class="dream-input-section">
                <div class="card">
                    <form id="dreamForm" method="POST" action="{% url 'dream_interpreter' %}" class="dream-form">
                        {% csrf_token %}
                        <div class="form-group">
                            <label for="dream_content" class="form-label dream-label">어떤 꿈을 꾸셨나요?</label>
                            <textarea
                                class="form-input dream-textarea"
                                id="dream_content"
                                name="input_text"
                                rows="6"
                                placeholder="돌아가신 할머니가 환하게 웃으며 돈을 주셨어요."
                                required
                            >{{ original_dream }}</textarea>
                        </div>
                        <button type="submit" class="btn btn-primary btn-large btn-full">
                            <span class="btn-icon">🔮</span>
                            해몽하기
                        </button>
                    </form>
                </div>
            </div>

            <!-- 해몽 결과 표시 영역 -->
            {% if interpretation_result %}
            <div class="results-section">
                <!-- 1. 꿈 종류 분석 -->
                {% if classification_result %}
                <div class="result-card">
                    <div class="result-header">
                        <span class="result-icon">📊</span>
                        <h3 class="result-title">AI가 분석한 나의 꿈 종류</h3>
                    </div>
                    <div class="result-content classification-result">
                        <p>{{ classification_result }}</p>
                    </div>
                </div>
                {% endif %}

                <!-- 2. 상세 해몽 -->
                <div class="result-card main-result">
                    <div class="result-header">
                        <span class="result-icon">🌙</span>
                        <h3 class="result-title">AI가 들려주는 나의 꿈 이야기</h3>
                    </div>
                    <div class="result-content">
                        <p>{{ interpretation_result }}</p>
                    </div>
                </div>

                <!-- 3. 핵심 키워드 -->
                {% if keywords_result %}
                <div class="result-card">
                    <div class="result-header">
                        <span class="result-icon">🔑</span>
                        <h3 class="result-title">꿈의 핵심 키워드</h3>
                    </div>
                    <div class="result-content keywords-result">
                        <p>{{ keywords_result }}</p>
                    </div>
                </div>
                {% endif %}

                <!-- 4. 세 줄 요약 -->
                {% if summary_result %}
                <div class="result-card">
                    <div class="result-header">
                        <span class="result-icon">✨</span>
                        <h3 class="result-title">세 줄 요약</h3>
                    </div>
                    <div class="result-content">
                        <p>{{ summary_result }}</p>
                    </div>
                </div>
                {% endif %}

                <!-- 액션 버튼들 -->
                <div class="action-buttons">
                    {% if user.is_authenticated %}
                    <form action="{% url 'diary_write' %}" method="POST" class="action-form">
                        {% csrf_token %}
                        <input type="hidden" name="dream_content" value="{{ original_dream }}">
                        <input type="hidden" name="interpretation_result" value="{{ interpretation_result }}">
                        <button type="submit" class="btn btn-primary btn-large">
                            <span class="btn-icon">📖</span>
                            내 일기장에 추가
                        </button>
                    </form>
                    {% else %}
                    <button class="btn btn-primary btn-large" onclick="redirectToLogin()">
                        <span class="btn-icon">📖</span>
                        내 일기장에 추가
                    </button>
                    {% endif %}

                    <button onclick="openShareModal()" class="btn btn-secondary btn-large">
                        <span class="btn-icon">📤</span>
                        공유하기
                    </button>
                </div>
            </div>
            {% endif %}

            <!-- 오류 메시지 표시 영역 -->
            {% if error %}
            <div class="error-message">
                <span class="error-icon">❌</span>
                <span class="error-text">{{ error }}</span>
            </div>
            {% endif %}
        </div>
    </main>

    <!-- 공유 모달 -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">해몽 결과 공유하기</h2>
                <button type="button" class="modal-close" onclick="closeShareModal()">✕</button>
            </div>
            <div class="modal-body">
                <p class="modal-description">아래 텍스트를 복사하여 친구나 SNS에 공유해보세요.</p>
                <textarea id="modalTextToCopy" class="modal-textarea" rows="8" readonly></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary btn-large" onclick="copyModalText()">
                    <span class="btn-icon">📋</span>
                    클립보드에 복사
                </button>
            </div>
        </div>
    </div>

    <!-- 복사 완료 알림 -->
    <div class="toast-notification" id="copyToast">
        <span class="toast-icon">✅</span>
        <span class="toast-text">클립보드에 복사되었습니다!</span>
    </div>

    {% include 'footer.html' %}

    <script src="{% static 'js/header.js' %}"></script>
    <script>
        // 폼 제출 시 로딩 스피너 표시
        document.getElementById('dreamForm').addEventListener('submit', function () {
            document.getElementById('loadingSpinner').style.display = 'flex';
        });

        function openShareModal() {
            const interpretation = '{{ interpretation_result }}';
            const keywords = '{{ keywords_result }}';

            const fullText = `🔮 DreamLens AI 꿈 해몽 결과 🔮\n\n🌙 상세 해몽\n${interpretation}\n\n🔑 꿈의 핵심 키워드\n${keywords}\n\n어젯밤 꾼 그 꿈, DreamLens에서 진짜 의미를 찾아보세요!\nhttps://www.dreamlens.com`;

            document.getElementById('modalTextToCopy').value = fullText;
            document.getElementById('modalOverlay').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeShareModal() {
            document.getElementById('modalOverlay').classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        function copyModalText() {
            const textElement = document.getElementById('modalTextToCopy');
            textElement.select();
            textElement.setSelectionRange(0, 99999);

            try {
                document.execCommand('copy');
                showToast();
                setTimeout(() => {
                    closeShareModal();
                }, 500);
            } catch (err) {
                alert('클립보드 복사에 실패했습니다.');
            }
        }

        function showToast() {
            const toast = document.getElementById('copyToast');
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function redirectToLogin() {
            alert("로그인이 필요한 서비스입니다.");
            window.location.href = "{% url 'login' %}?next={{ request.path }}";
        }

        // 모달 외부 클릭 시 닫기
        document.getElementById('modalOverlay').addEventListener('click', function(e) {
            if (e.target === this) {
                closeShareModal();
            }
        });

        // ESC 키로 모달 닫기
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeShareModal();
            }
        });
    </script>
</body>
</html>